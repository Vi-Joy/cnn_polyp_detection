import caffe
import surgery, score
import pdb
import numpy as np
import os, sys
import setproctitle
setproctitle.setproctitle(os.path.basename(os.getcwd()))

# set gpu mode
caffe.set_mode_gpu()
caffe.set_device(0);

# RGB GoogLeNet architecture file path
prototxt_file = 'googlenet_original.prototxt'
# RGB pre-trained weights path
weights = 'bvlc_googlenet.caffemodel'

# Initialize RGB CNN
base_net = caffe.Net(prototxt_file, weights, caffe.TRAIN)

# Initialize SGD solver for the RGBD CNN
solver = caffe.SGDSolver('solver.prototxt')

# copy filter weights from the RGB model to the RGBD model
# this will copy weights from the parameters with the same
# name in the RGB and RGBD model. Since the input layer will
# be 4-channel instead of 3-channel (RGBD instead of RGB), it
# has a different name, so the weights will not be copied
surgery.transplant(solver.net, base_net)

# Resize blobs corresponding to deconvolutions
interp_layers = [k for k in solver.net.params.keys() if 'up' in k]
surgery.interp(solver.net, interp_layers)

# Copy the first 3 input filter weights (RGB) to the RGBD model
# Initialize the depth channel filter weights as the average of the RGB weights
# Copy the filter bias terms
solver.net.params['conv1_1_bgrd'][0].data[:, :3] = base_net.params['conv1/7x7_s2'][0].data
solver.net.params['conv1_1_bgrd'][0].data[:, 3] = np.mean(base_net.params['conv1/7x7_s2'][0].data, axis=1)
solver.net.params['conv1_1_bgrd'][1].data[...] = base_net.params['conv1/7x7_s2'][1].data

del base_net

# Start Training
solver.solve()
